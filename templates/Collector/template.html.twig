{% extends '@WebProfiler/Profiler/layout.html.twig' %}

{% block head %}
    {{ parent() }}

    <style>
        tr { vertical-align: center; }
        .sf-toggle { cursor: pointer; }
        .toggle-button { right: 6px; top: 6px; opacity: .5; pointer-events: none; }

        .icon svg { height: 24px; width: 24px; fill: var(--badge-color); }
        .sf-toggle-off .icon-close, .sf-toggle-on .icon-open { display: none; }
        .sf-toggle-off .icon-open, .sf-toggle-on .icon-close { display: block; }
        .d-flex { display: flex; align-items: center; }
        .d-flex .col { flex: 1; }
    </style>
{% endblock head %}

{% block toolbar %}
    {% set matching = collector.watchdogs|filter(v => v.hasMatches) %}
    {% set hasMatches = matching|length %}
    {% set matchCount = collector.matchingWatchdogsCount %}

    {% set icon %}
        {{ source('@Watchdog/Collector/icon.svg') }}
        {% if matchCount %}
            <span class="sf-toolbar-value">{{ matchCount }}</span>
        {% endif %}
    {% endset %}

    {% set text %}
        {# this is the content displayed when hovering the mouse over
           the toolbar panel #}
        {% for watchdogId, watchdog in matching %}
        <div class="sf-toolbar-info-group">
            {% if watchdog.matchingUnits|length %}
                <h3>{{ watchdogId|title }}</h3>
            {% endif %}
            <div class="sf-toolbar-info-piece">
                {% for matchingUnit in watchdog.matchingUnits %}
                    <div class="sf-toolbar-info-piece">
                        <b>{{ matchingUnit.type|title }}</b>
                        {% if 'compound' != matchingUnit.type %}
                            <span class="sf-toolbar-status">{{ matchingUnit.originalConfig }}</span>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}

        {% if 0 == matchCount %}
            There's nothing to bark at
        {% endif %}
    {% endset %}

    {% if collector.watchdogs %}
        {{ include('@WebProfiler/Profiler/toolbar_item.html.twig', {
            link: profiler_url,
            status: matchCount  ? 'green'
        }) }}
    {% endif %}
{% endblock %}

{% block menu %}
    {% set matchCount = collector.matchingWatchdogsCount %}
    {# This left-hand menu appears when using the full-screen profiler. #}
    <span class="label{{ 0 == collector.watchdogs|filter(v => v.hasUnits)|length ? ' disabled' }}">
        <span class="icon">
             {{ source('@Watchdog/Collector/icon.svg') }} <span class="hidden-small"></span>
        </span>
        <strong>Watchdog</strong>
        {% if matchCount %}
        <span class="count">{{ matchCount }}</span>
        {% endif %}
    </span>
{% endblock %}

{% block panel %}
    {# Optional, for showing the most details. #}
    <h2>Watchdog</h2>
    {% set watchdogsCount = collector.watchdogs|filter(v => v.hasUnits)|length %}
    {% set matchCount = collector.matchingWatchdogsCount %}

    <div class="metrics">
        <div class="metric">
            <span class="value">{{ watchdogsCount }}</span>
            <span class="label">Watchdogs</span>
        </div>

        <div class="metric">
            <span class="value">{{ matchCount}}</span>
            <span class="label">Matches</span>
        </div>

        <div class="metric">
            <span class="value">{{ 'now'|date('Y-m-d H:i') }}</span>
            <span class="label">Current date-time</span>
        </div>

    </div>

    {% for watchdogId, watchdog in collector.watchdogs|filter(v => v.hasUnits) %}
        <h3 class="d-flex">
            {{ watchdogId|title }}
            <span class="col text-right">
                {{ source('@WebProfiler/Icon/' ~ (watchdog.isWoofTime ? 'yes' : 'no-gray') ~ '.svg') }}
            </span>
        </h3>
        <table>
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Value</th>
                    <th>Match</th>
                </tr>
            </thead>
            <tbody>
            {% for index,unit in watchdog.units %}
                <tr>
                {% if 'compound' != unit.type %}
                    <td class="font-normal">{{ unit.type|title }}</td>
                    <td class="font-normal"> {{ unit.originalConfig }}</td>
                    <td>
                        <span class="value">
                            {{ source('@WebProfiler/Icon/' ~ (unit.isMatching ? 'yes' : 'no-gray') ~ '.svg') }}
                        </span>
                    </td>
                {% else %}
                    {% set matchCount = unit.units|filter(v => v.isMatching)|length %}
                    <td colspan="3">
                        <div class="sf-toggle d-flex" data-toggle-selector="#content-{{ index }}">
                            <div class="col">
                                <span class="font-normal">
                                    Compound
                                </span>
                            </div>
                            <a class="toggle-button col">
                                <span class="icon icon-close">{{ source('@WebProfiler/images/icon-minus-square.svg') }}</span>
                                <span class="icon icon-open">{{ source('@WebProfiler/images/icon-plus-square.svg') }}</span>
                            </a>
                            <div class="col"></div>
                            <div class="col">
                                <span class="value">
                                    {{ source('@WebProfiler/Icon/' ~ (unit.isMatching ? 'yes' : 'no-gray') ~ '.svg') }}
                                </span>
                                <span class="label status-{{ unit.units|length == matchCount ? 'success' : 'normal' }}">
                                    {{ matchCount }} / {{ unit.units|length }}
                                </span>
                            </div>
                        </div>
                        <div id="content-{{ index }}" class="context sf-toggle-content sf-toggle-hidden">
                            <table>
                                <thead>
                                    <tr>
                                        <th class="font-normal">Type</th>
                                        <th class="font-normal">Value</th>
                                        <th class="font-normal">Match</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for subunit in unit.units %}
                                    <tr>
                                        <td class="font-normal">{{ subunit.type|title }}</td>
                                        <td class="font-normal"> {{ subunit.originalConfig }}</td>
                                        <td>
                                            <span class="value">
                                                {{ source('@WebProfiler/Icon/' ~ (subunit.isMatching ? 'yes' : 'no-gray') ~ '.svg') }}
                                            </span>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </td>
                {% endif %}
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="empty">
            <p>Nothing was configured ...</p>
        </div>
    {% endfor %}
{% endblock %}
